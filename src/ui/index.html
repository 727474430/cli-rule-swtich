<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRS - CLI Rule Switcher</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content {
      display: block;
    }
    .tab-content.hidden {
      display: none;
    }
    .tab-active {
      border-bottom: 2px solid #3b82f6 !important;
      color: #2563eb !important;
    }
    .profile-card-active {
      @apply ring-2 ring-blue-500 bg-blue-50;
    }
    /* æ–œè§’é£˜å¸¦æ ·å¼ */
    .ribbon {
      position: absolute;
      top: 0;
      left: 0;
      width: 80px;
      padding: 6px 0;
      font-size: 10px;
      font-weight: 700;
      color: white;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transform: translate(-25%, 25%) rotate(-45deg);
      transform-origin: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    .ribbon-claude {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    .ribbon-codex {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .ribbon-auto {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    /* å¡ç‰‡éœ€è¦ç›¸å¯¹å®šä½å’Œæº¢å‡ºéšè— */
    .card-with-ribbon {
      position: relative;
      overflow: hidden;
    }
    /* å·¥å…·ç±»å‹åˆ‡æ¢æŒ‰é’® */
    .tool-type-btn {
      color: #6b7280;
    }
    .tool-type-btn.active {
      background: white;
      color: #1f2937;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .tool-type-btn:hover:not(.active) {
      color: #374151;
    }
    /* æ¨¡æ€æ¡†åŠ¨ç”» */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .modal-backdrop {
      animation: modalFadeIn 0.2s ease-out;
    }
    .modal-content {
      animation: modalSlideIn 0.3s ease-out;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- å¯¼èˆªæ  -->
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-gray-900">CRS</h1>
          <span class="ml-3 text-sm text-gray-500">CLI Rule Switcher</span>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-600">å½“å‰ Profile: <strong id="current-profile-name" class="text-blue-600">åŠ è½½ä¸­...</strong></span>
          <button onclick="refreshData()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            åˆ·æ–°
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Tab å¯¼èˆª -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8 overflow-x-auto">
        <button onclick="switchTab('profiles')" id="tab-profiles" class="border-b-2 border-transparent text-gray-500 py-4 px-1 text-sm font-medium whitespace-nowrap">
          ğŸ“‹ é…ç½®ç®¡ç†
        </button>
        <button onclick="switchTab('templates')" id="tab-templates" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
          ğŸ“¦ æ¨¡æ¿åº“
        </button>
        <button onclick="switchTab('remotes')" id="tab-remotes" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
          ğŸŒ è¿œç¨‹æº
        </button>
        <button onclick="switchTab('backups')" id="tab-backups" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
          ğŸ’¾ å¤‡ä»½ç®¡ç†
        </button>
        <button onclick="switchTab('about')" id="tab-about" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
          â„¹ï¸ å…³äº
        </button>
      </nav>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Profiles åˆ—è¡¨ Tab -->
    <div id="content-profiles" class="tab-content">
      <div class="mb-4 space-y-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h2 class="text-xl font-semibold text-gray-900">é…ç½®ç®¡ç†</h2>
            <button onclick="openCreateProfileModal()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-1">
              <span>â•</span>
              <span>åˆ›å»º Profile</span>
            </button>
          </div>
          <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-600">å·¥å…·ç±»å‹:</span>
            <div class="inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1">
              <button onclick="setToolTypeFilter('claude')" id="filter-claude" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
                Claude
              </button>
              <button onclick="setToolTypeFilter('codex')" id="filter-codex" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
                Codex
              </button>
            </div>
          </div>
        </div>
        
        <!-- æœç´¢æ¡† -->
        <div class="relative">
          <input 
            type="text" 
            id="profile-search" 
            placeholder="ğŸ” æœç´¢ Profile (åç§°ã€æè¿°)..." 
            oninput="filterProfiles()"
            class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
      </div>
      
      <div id="profiles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
        <!-- åŠ¨æ€åŠ è½½ profile å¡ç‰‡ -->
      </div>
      
      <div id="empty-state" class="text-center py-12 hidden">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">æš‚æ—  Profiles</h3>
        <p class="mt-1 text-sm text-gray-500">åˆ›å»ºä¸€ä¸ªæ–°çš„ Profile å¼€å§‹ä½¿ç”¨</p>
        <div class="mt-6">
          <button onclick="switchTab('create')" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            åˆ›å»º Profile
          </button>
        </div>
      </div>
    </div>

    <!-- Templates Tab -->
    <div id="content-templates" class="tab-content hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">æ¨¡æ¿ç®¡ç†</h2>
      
      <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">ä»å†…ç½®æ¨¡æ¿å¿«é€Ÿåˆ›å»º Profile</p>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">å·¥å…·ç±»å‹:</span>
          <div class="inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1">
            <button onclick="setTemplateFilter('claude')" id="template-claude" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Claude
            </button>
            <button onclick="setTemplateFilter('codex')" id="template-codex" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Codex
            </button>
          </div>
        </div>
      </div>
      
      <div id="templates-loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
      </div>
      
      <div id="templates-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
        <!-- åŠ¨æ€åŠ è½½æ¨¡æ¿å¡ç‰‡ -->
      </div>
      
      <div id="templates-empty" class="text-center py-12 hidden">
        <p class="text-gray-500">æš‚æ— å¯ç”¨æ¨¡æ¿</p>
      </div>
    </div>

    <!-- Remote æº Tab -->
    <div id="content-remotes" class="tab-content hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">è¿œç¨‹æºç®¡ç†</h2>
      
      <!-- å¿«é€Ÿå®‰è£…åŒºåŸŸ -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm p-6 mb-6 border border-blue-100">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <span class="text-2xl mr-2">âš¡</span>
          ä» GitHub URL å¿«é€Ÿå®‰è£…
        </h3>
        <form id="quick-install-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="quick-url" class="block text-sm font-medium text-gray-700">GitHub URL *</label>
              <input type="url" id="quick-url" required placeholder="https://github.com/user/repo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <p class="mt-1 text-xs text-gray-500">æ”¯æŒå®Œæ•´ GitHub URL æˆ–ç®€å†™æ ¼å¼</p>
            </div>
            <div>
              <label for="quick-profile-name" class="block text-sm font-medium text-gray-700">Profile åç§° *</label>
              <input type="text" id="quick-profile-name" required placeholder="my-profile" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <p class="mt-1 text-xs text-gray-500">å®‰è£…åå¯ç›´æ¥ä½¿ç”¨</p>
            </div>
          </div>
          <div>
            <label for="quick-tool-type" class="block text-sm font-medium text-gray-700">å·¥å…·ç±»å‹ *</label>
            <select id="quick-tool-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="claude">Claude</option>
              <option value="codex">Codex</option>
            </select>
          </div>
          <div>
            <label for="quick-description" class="block text-sm font-medium text-gray-700">æè¿°</label>
            <textarea id="quick-description" rows="2" placeholder="ç®€è¦æè¿°è¯¥ Profile çš„ç”¨é€”..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            <p class="mt-1 text-xs text-gray-500">å¯é€‰ï¼Œä¾¿äºåœ¨é…ç½®ç®¡ç†ä¸­è¯†åˆ«</p>
          </div>
          <div class="flex justify-end">
            <button type="submit" class="px-6 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
              ğŸš€ å®‰è£…åˆ° Profile
            </button>
          </div>
        </form>
      </div>
      
      <!-- å·²å®‰è£…çš„è¿œç¨‹æºåˆ—è¡¨ -->
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">å·²å®‰è£…çš„è¿œç¨‹æº</h3>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">å·¥å…·ç±»å‹:</span>
          <div class="inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1">
            <button onclick="setRemoteFilter('claude')" id="remote-claude" class="tool-type-btn active px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Claude
            </button>
            <button onclick="setRemoteFilter('codex')" id="remote-codex" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Codex
            </button>
          </div>
        </div>
      </div>
      
      <div id="remotes-loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
      </div>
      
      <div id="remotes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
        <!-- åŠ¨æ€åŠ è½½è¿œç¨‹æºåˆ—è¡¨ -->
      </div>
      
      <div id="remotes-empty" class="text-center py-12 hidden">
        <p class="text-gray-500">æš‚æ— è¿œç¨‹æº</p>
      </div>
    </div>

    <!-- Backups Tab -->
    <div id="content-backups" class="tab-content hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">å¤‡ä»½ç®¡ç†</h2>
      
      <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">æŸ¥çœ‹å’Œæ¢å¤é…ç½®å¤‡ä»½</p>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">å·¥å…·ç±»å‹:</span>
          <div class="inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1">
            <button onclick="setBackupFilter('claude')" id="backup-claude" class="tool-type-btn active px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Claude
            </button>
            <button onclick="setBackupFilter('codex')" id="backup-codex" class="tool-type-btn px-4 py-1.5 text-sm font-medium rounded-md transition-all">
              Codex
            </button>
          </div>
        </div>
      </div>
      
      <div id="backups-loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
      </div>
      
      <div id="backups-list" class="bg-white shadow overflow-hidden sm:rounded-md">
        <!-- åŠ¨æ€åŠ è½½å¤‡ä»½åˆ—è¡¨ -->
      </div>
      
      <div id="backups-empty" class="text-center py-12 hidden">
        <p class="text-gray-500">æš‚æ— å¤‡ä»½</p>
      </div>
    </div>

    <!-- å…³äº Tab -->
    <div id="content-about" class="tab-content hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">å…³äº CRS</h2>
      
      <div class="bg-white rounded-lg shadow p-6 space-y-4">
        <div>
          <h3 class="text-lg font-medium text-gray-900">CLI Rule Switcher</h3>
          <p class="mt-2 text-gray-600">ä¸€ä¸ªç”¨äºç®¡ç†å’Œåˆ‡æ¢å¤šä¸ª Claude Code / Codex é…ç½®æ–‡ä»¶çš„å·¥å…·ã€‚</p>
        </div>
        
        <div class="border-t border-gray-200 pt-4">
          <h4 class="font-medium text-gray-900 mb-2">åŠŸèƒ½ç‰¹æ€§</h4>
          <ul class="list-disc list-inside space-y-1 text-gray-600">
            <li>æ”¯æŒ Claude å’Œ Codex ä¸¤ç§å·¥å…·ç±»å‹</li>
            <li>å¿«é€Ÿåˆ‡æ¢ä¸åŒçš„é…ç½® Profile</li>
            <li>ä»å½“å‰é…ç½®æˆ–ç©ºç™½åˆ›å»ºæ–° Profile</li>
            <li>é…ç½®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤</li>
            <li>æ¨¡æ¿åº“ï¼šä»å†…ç½®æ¨¡æ¿å¿«é€Ÿåˆ›å»º</li>
            <li>è¿œç¨‹æºï¼šä» GitHub ä¸€é”®å®‰è£…</li>
            <li>å¤‡ä»½ç®¡ç†ï¼šè‡ªåŠ¨å¤‡ä»½å¹¶æ”¯æŒæ¢å¤</li>
          </ul>
        </div>
        
        <div class="border-t border-gray-200 pt-4">
          <h4 class="font-medium text-gray-900 mb-2">CLI å‘½ä»¤</h4>
          <div class="bg-gray-50 rounded p-4 font-mono text-sm space-y-1">
            <div><span class="text-blue-600">crs ui</span> - å¯åŠ¨å›¾å½¢ç•Œé¢ï¼ˆå½“å‰é¡µé¢ï¼‰</div>
            <div><span class="text-blue-600">crs list</span> - åˆ—å‡ºæ‰€æœ‰ profiles</div>
            <div><span class="text-blue-600">crs use &lt;name&gt;</span> - åˆ‡æ¢åˆ°æŒ‡å®š profile</div>
            <div><span class="text-blue-600">crs save &lt;name&gt;</span> - ä¿å­˜å½“å‰é…ç½®ä¸ºæ–° profile</div>
            <div><span class="text-blue-600">crs create &lt;name&gt;</span> - åˆ›å»ºç©ºç™½ profile</div>
            <div><span class="text-blue-600">crs delete &lt;name&gt;</span> - åˆ é™¤ profile</div>
            <div><span class="text-blue-600">crs template list</span> - åˆ—å‡ºæ‰€æœ‰æ¨¡æ¿</div>
            <div><span class="text-blue-600">crs remote list</span> - åˆ—å‡ºè¿œç¨‹æº</div>
          </div>
        </div>
        
        <div class="border-t border-gray-200 pt-4">
          <h4 class="font-medium text-gray-900 mb-2">é…ç½®ç›®å½•</h4>
          <p class="text-sm text-gray-600 font-mono bg-gray-50 p-2 rounded">~/.crs-profiles/</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast é€šçŸ¥ -->
  <div id="toast" class="fixed top-4 right-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-4 max-w-md min-w-80 border border-gray-200">
      <div class="flex items-start">
        <div id="toast-icon" class="flex-shrink-0"></div>
        <div class="ml-3 flex-1">
          <p id="toast-message" class="text-sm font-medium text-gray-900 whitespace-nowrap"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let currentProfile = null;
    let profiles = [];
    let templates = [];
    let remotes = [];
    let backups = [];
    let currentToolType = 'claude'; // å½“å‰é€‰ä¸­çš„å·¥å…·ç±»å‹ï¼ˆProfilesï¼‰
    let currentTemplateFilter = 'claude'; // å½“å‰æ¨¡æ¿è¿‡æ»¤å™¨
    let currentRemoteFilter = 'claude'; // å½“å‰è¿œç¨‹æºè¿‡æ»¤å™¨
    let currentBackupFilter = 'claude'; // å½“å‰å¤‡ä»½è¿‡æ»¤å™¨

    // ========================================
    // å·¥å…·ç±»å‹åˆ‡æ¢ç³»ç»Ÿ
    // ========================================
    
    function setToolTypeFilter(type) {
      currentToolType = type;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#filter-claude, #filter-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${type}`).classList.add('active');
      // åˆ·æ–°æ•°æ®
      refreshData();
    }
    
    function getToolType() {
      return currentToolType;
    }
    
    function setTemplateFilter(type) {
      currentTemplateFilter = type;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#template-claude, #template-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`template-${type}`).classList.add('active');
      // åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
      loadTemplates();
    }
    
    function getTemplateFilter() {
      return currentTemplateFilter;
    }
    
    function setBackupFilter(type) {
      currentBackupFilter = type;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#backup-claude, #backup-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`backup-${type}`).classList.add('active');
      // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
      loadBackups();
    }
    
    function getBackupFilter() {
      return currentBackupFilter;
    }
    
    function setRemoteFilter(type) {
      currentRemoteFilter = type;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#remote-claude, #remote-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`remote-${type}`).classList.add('active');
      // åˆ·æ–°è¿œç¨‹æºåˆ—è¡¨
      renderRemotes();
    }
    
    function getRemoteFilter() {
      return currentRemoteFilter;
    }
    
    function setCreateToolType(type) {
      document.getElementById('profile-tool-type').value = type;
      document.querySelectorAll('#create-claude, #create-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`create-${type}`).classList.add('active');
    }

    // ========================================
    // æ¨¡æ€æ¡†ç³»ç»Ÿ
    // ========================================
    
    function openModal(content) {
      const modalContainer = document.getElementById('modal-container');
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = content;
      modalContainer.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // æ·»åŠ  ESC é”®ç›‘å¬
      document.addEventListener('keydown', handleEscKey);
    }

    function closeModal() {
      const modalContainer = document.getElementById('modal-container');
      modalContainer.classList.add('hidden');
      document.body.style.overflow = '';
      
      // ç§»é™¤ ESC é”®ç›‘å¬
      document.removeEventListener('keydown', handleEscKey);
    }

    function handleEscKey(e) {
      if (e.key === 'Escape') {
        // å¦‚æœæœ‰ Cancel å¤„ç†å‡½æ•°ï¼Œè°ƒç”¨å®ƒï¼›å¦åˆ™ç›´æ¥å…³é—­
        if (window.handleConfirmCancel) {
          window.handleConfirmCancel();
        } else if (window.handlePromptCancel) {
          window.handlePromptCancel();
        } else {
          closeModal();
        }
      }
    }

    // è‡ªå®šä¹‰ confirm å¯¹è¯æ¡†
    function showConfirm(message, title = 'ç¡®è®¤æ“ä½œ') {
      return new Promise((resolve) => {
        const content = `
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
              <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">${title}</h3>
            <p class="text-sm text-gray-500 mb-6">${message}</p>
            <div class="flex space-x-3">
              <button onclick="handleConfirmCancel()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                å–æ¶ˆ
              </button>
              <button onclick="handleConfirmOk()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ç¡®å®š
              </button>
            </div>
          </div>
        `;
        
        openModal(content);
        
        window.handleConfirmOk = () => {
          closeModal();
          resolve(true);
        };
        
        window.handleConfirmCancel = () => {
          closeModal();
          resolve(false);
        };
      });
    }

    // è‡ªå®šä¹‰ prompt è¾“å…¥æ¡†
    function showPrompt(message, defaultValue = '', title = 'è¯·è¾“å…¥') {
      return new Promise((resolve) => {
        const content = `
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">${title}</h3>
            <p class="text-sm text-gray-500 mb-4">${message}</p>
            <input 
              type="text" 
              id="prompt-input" 
              value="${defaultValue}" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-6"
              placeholder="è¯·è¾“å…¥..."
              autocomplete="off"
            />
            <div class="flex space-x-3">
              <button onclick="handlePromptCancel()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                å–æ¶ˆ
              </button>
              <button onclick="handlePromptOk()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ç¡®å®š
              </button>
            </div>
          </div>
        `;
        
        openModal(content);
        
        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('prompt-input');
          input.focus();
          input.select();
          
          // æ”¯æŒå›è½¦ç¡®è®¤
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              window.handlePromptOk();
            }
          });
        }, 100);
        
        window.handlePromptOk = () => {
          const input = document.getElementById('prompt-input');
          const value = input.value.trim();
          closeModal();
          resolve(value || null);
        };
        
        window.handlePromptCancel = () => {
          closeModal();
          resolve(null);
        };
      });
    }

    // Tab åˆ‡æ¢
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('border-transparent', 'text-gray-500');
      });

      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      const activeTab = document.getElementById(`tab-${tabName}`);
      activeTab.classList.add('tab-active');
      activeTab.classList.remove('border-transparent', 'text-gray-500');

      // åŠ è½½å¯¹åº”æ•°æ®
      if (tabName === 'templates') loadTemplates();
      if (tabName === 'remotes') loadRemotes();
      if (tabName === 'backups') loadBackups();
    }

    // Toast é€šçŸ¥
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');
      
      toastMessage.textContent = message;
      
      if (type === 'success') {
        toastIcon.innerHTML = '<svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
      } else if (type === 'error') {
        toastIcon.innerHTML = '<svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // ============ Profiles ç›¸å…³å‡½æ•° ============
    
    async function fetchCurrentProfile() {
      try {
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/current?toolType=${toolType}`);
        const result = await response.json();
        
        if (result.success) {
          currentProfile = result.data.name;
          document.getElementById('current-profile-name').textContent = currentProfile || 'æœªè®¾ç½®';
        }
      } catch (error) {
        console.error('è·å–å½“å‰ profile å¤±è´¥:', error);
      }
    }

    async function fetchProfiles() {
      const loading = document.getElementById('loading');
      const grid = document.getElementById('profiles-grid');
      const emptyState = document.getElementById('empty-state');
      
      loading.classList.remove('hidden');
      grid.classList.add('hidden');
      emptyState.classList.add('hidden');
      
      try {
        const toolType = getToolType();
        const response = await fetch(`/api/profiles?toolType=${toolType}`);
        const result = await response.json();
        
        if (result.success) {
          profiles = result.data;
          renderProfiles();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('è·å– profiles å¤±è´¥:', error);
        showToast('è·å– profiles å¤±è´¥', 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    function filterProfiles() {
      const searchInput = document.getElementById('profile-search');
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰
      if (!searchTerm) {
        renderProfiles();
        return;
      }
      
      // è¿‡æ»¤ profiles
      const filtered = profiles.filter(profile => {
        const nameMatch = profile.name.toLowerCase().includes(searchTerm);
        const descMatch = (profile.description || '').toLowerCase().includes(searchTerm);
        return nameMatch || descMatch;
      });
      
      // æ¸²æŸ“è¿‡æ»¤åçš„ç»“æœ
      renderProfiles(filtered);
    }
    
    function renderProfiles(profilesToRender = null) {
      const grid = document.getElementById('profiles-grid');
      const emptyState = document.getElementById('empty-state');
      let displayProfiles = profilesToRender || profiles;
      
      // å°†å½“å‰æ¿€æ´»çš„ Profile æ’åœ¨ç¬¬ä¸€ä½
      displayProfiles = [...displayProfiles].sort((a, b) => {
        const aIsActive = a.name === currentProfile;
        const bIsActive = b.name === currentProfile;
        if (aIsActive && !bIsActive) return -1;
        if (!aIsActive && bIsActive) return 1;
        return 0; // ä¿æŒå…¶ä»–é¡¹çš„åŸæœ‰é¡ºåº
      });
      
      if (displayProfiles.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        // å¦‚æœæ˜¯æœç´¢ç»“æœä¸ºç©ºï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
        const searchInput = document.getElementById('profile-search');
        if (searchInput.value.trim()) {
          emptyState.innerHTML = `
            <div class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">æœªæ‰¾åˆ°åŒ¹é…çš„ Profile</h3>
              <p class="mt-1 text-sm text-gray-500">è¯•è¯•å…¶ä»–æœç´¢è¯æˆ–æ¸…ç©ºæœç´¢æ¡†</p>
            </div>
          `;
        } else {
          emptyState.innerHTML = `
            <div class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">è¿˜æ²¡æœ‰ Profile</h3>
              <p class="mt-1 text-sm text-gray-500">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª Profile å¼€å§‹ä½¿ç”¨</p>
            </div>
          `;
        }
        return;
      }
      
      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      grid.innerHTML = displayProfiles.map(profile => {
        const isActive = profile.name === currentProfile;
        const activeClass = isActive ? 'profile-card-active' : '';
        
        return `
          <div class="bg-white rounded-lg shadow p-4 hover:shadow-md transition-shadow ${activeClass} flex flex-col h-full card-with-ribbon">
            <div class="ribbon ribbon-${profile.toolType}">${profile.toolType}</div>
            
            <div class="text-center mb-2 mt-2">
              <h3 class="text-lg font-semibold text-gray-900">${profile.name}</h3>
              ${isActive ? '<div class="mt-1"><span class="px-2 py-1 text-xs font-medium text-blue-800 bg-blue-100 rounded">å½“å‰</span></div>' : ''}
            </div>
            
            <p class="text-sm text-gray-600 mb-3 text-center">${profile.description || 'æ— æè¿°'}</p>
            
            <div class="space-y-1 text-xs text-gray-500 mb-4 flex-1">
              <div>åˆ›å»ºæ—¶é—´: ${new Date(profile.createdAt).toLocaleString('zh-CN')}</div>
              ${profile.lastUsed ? `<div>æœ€åä½¿ç”¨: ${new Date(profile.lastUsed).toLocaleString('zh-CN')}</div>` : ''}
            </div>
            
            <div class="space-y-2 mt-auto">
              <button onclick="viewProfile('${profile.name}')" class="w-full px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50">
                ğŸ“ æŸ¥çœ‹å†…å®¹
              </button>
              <div class="flex space-x-2">
                ${!isActive ? `
                  <button onclick="switchProfile('${profile.name}')" class="flex-1 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                    åˆ‡æ¢
                  </button>
                ` : ''}
                <button onclick="deleteProfile('${profile.name}')" class="flex-1 px-3 py-1.5 text-sm font-medium text-red-600 bg-white border border-red-300 rounded hover:bg-red-50">
                  åˆ é™¤
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function switchProfile(name) {
      const confirmed = await showConfirm(`ç¡®å®šè¦åˆ‡æ¢åˆ° "${name}" å—ï¼Ÿ`, 'åˆ‡æ¢ Profile');
      if (!confirmed) return;
      
      try {
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/${name}/switch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ toolType })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          await refreshData();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('åˆ‡æ¢ profile å¤±è´¥:', error);
        showToast('åˆ‡æ¢ profile å¤±è´¥', 'error');
      }
    }

    async function deleteProfile(name) {
      const confirmed = await showConfirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`, 'åˆ é™¤ Profile');
      if (!confirmed) return;
      
      try {
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/${name}?toolType=${toolType}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          await refreshData();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤ profile å¤±è´¥:', error);
        showToast('åˆ é™¤ profile å¤±è´¥', 'error');
      }
    }

    function resetCreateForm() {
      document.getElementById('create-form').reset();
      document.getElementById('from-current').checked = true;
      // é‡ç½®å·¥å…·ç±»å‹æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#create-claude, #create-codex').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('create-claude').classList.add('active');
      document.getElementById('profile-tool-type').value = 'claude';
    }
    
    function openCreateProfileModal() {
      const modal = document.getElementById('create-profile-modal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      // é‡ç½®è¡¨å•
      resetCreateForm();
    }
    
    function closeCreateProfileModal() {
      const modal = document.getElementById('create-profile-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // ============ Templates ç›¸å…³å‡½æ•° ============
    
    async function loadTemplates() {
      const loading = document.getElementById('templates-loading');
      const grid = document.getElementById('templates-grid');
      const empty = document.getElementById('templates-empty');
      
      loading.classList.remove('hidden');
      grid.classList.add('hidden');
      empty.classList.add('hidden');
      
      try {
        const toolType = getTemplateFilter();
        const url = toolType ? `/api/templates?toolType=${toolType}` : '/api/templates';
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          templates = result.data;
          renderTemplates();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
        showToast('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥', 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    function renderTemplates() {
      const grid = document.getElementById('templates-grid');
      const empty = document.getElementById('templates-empty');
      
      if (templates.length === 0) {
        grid.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }
      
      grid.classList.remove('hidden');
      empty.classList.add('hidden');
      
      grid.innerHTML = templates.map(template => `
        <div class="bg-white rounded-lg shadow p-4 hover:shadow-md transition-shadow flex flex-col h-full card-with-ribbon">
          <div class="ribbon ribbon-${template.toolType}">${template.toolType}</div>
          
          <h3 class="text-lg font-semibold text-gray-900 mb-2 mt-2 text-center">${template.name}</h3>
          <p class="text-sm text-gray-600 mb-4 flex-1 text-center">${template.description || 'æ— æè¿°'}</p>
          
          <button onclick="installTemplate('${template.name}', '${template.toolType}')" class="w-full px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 mt-auto">
            å®‰è£…æ¨¡æ¿
          </button>
        </div>
      `).join('');
    }

    async function installTemplate(templateName, toolType) {
      const profileName = await showPrompt('è¯·è¾“å…¥æ–° Profile çš„åç§°', '', 'å®‰è£…æ¨¡æ¿');
      if (!profileName) return;
      
      try {
        const response = await fetch('/api/templates/install', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ templateName, profileName, toolType })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          switchTab('profiles');
          await refreshData();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('å®‰è£…æ¨¡æ¿å¤±è´¥:', error);
        showToast('å®‰è£…æ¨¡æ¿å¤±è´¥', 'error');
      }
    }

    // ============ Remotes ç›¸å…³å‡½æ•° ============
    
    async function loadRemotes() {
      const loading = document.getElementById('remotes-loading');
      const list = document.getElementById('remotes-list');
      const empty = document.getElementById('remotes-empty');
      
      loading.classList.remove('hidden');
      list.classList.add('hidden');
      empty.classList.add('hidden');
      
      try {
        const response = await fetch('/api/remotes');
        const result = await response.json();
        
        if (result.success) {
          remotes = result.data;
          renderRemotes();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('è·å–è¿œç¨‹æºå¤±è´¥:', error);
        showToast('è·å–è¿œç¨‹æºå¤±è´¥', 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    function renderRemotes() {
      const list = document.getElementById('remotes-list');
      const empty = document.getElementById('remotes-empty');
      
      // æ ¹æ®è¿‡æ»¤å™¨è¿‡æ»¤è¿œç¨‹æº
      const filter = getRemoteFilter();
      const filteredRemotes = remotes.filter(remote => {
        // å¦‚æœ remote æ²¡æœ‰ toolType æˆ–ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè§†ä¸º 'auto'ï¼Œå¯ä»¥åŒ¹é…ä»»ä½•è¿‡æ»¤å™¨
        const remoteType = remote.toolType || 'auto';
        return remoteType === filter || remoteType === 'auto';
      });
      
      if (filteredRemotes.length === 0) {
        list.classList.add('hidden');
        empty.classList.remove('hidden');
        // æ ¹æ®æ˜¯å¦æœ‰åŸå§‹æ•°æ®å†³å®šæç¤ºå†…å®¹
        if (remotes.length === 0) {
          empty.innerHTML = '<div class="text-center py-12"><p class="text-gray-500">æš‚æ— è¿œç¨‹æº</p></div>';
        } else {
          empty.innerHTML = '<div class="text-center py-12"><p class="text-gray-500">è¯¥ç±»å‹æš‚æ— è¿œç¨‹æº</p></div>';
        }
        return;
      }
      
      list.classList.remove('hidden');
      empty.classList.add('hidden');
      
      list.innerHTML = filteredRemotes.map(remote => `
        <div class="bg-white rounded-lg shadow p-4 flex flex-col h-full card-with-ribbon">
          <div class="ribbon ribbon-${remote.toolType || 'auto'}">${remote.toolType || 'auto'}</div>
          
          <div class="text-center mb-3 mt-2">
            <h3 class="text-lg font-semibold text-gray-900">${remote.name}</h3>
          </div>
          
          ${remote.description ? `<p class="text-sm text-gray-600 mb-3 text-center">${remote.description}</p>` : ''}
          
          <p class="text-xs text-gray-500 font-mono mb-3 break-all ${remote.description ? '' : 'flex-1'}">${remote.url}</p>
          
          <div class="text-xs text-gray-400 mb-3 text-center">
            æœ€ååŒæ­¥: ${remote.lastSync ? new Date(remote.lastSync).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'æœªçŸ¥'}
          </div>
          
          <div class="flex space-x-2 mt-auto">
            <button onclick="installFromRemote('${remote.url}', '${remote.toolType}')" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700 transition-colors">
              ğŸ”„ å†æ¬¡å®‰è£…
            </button>
            <button onclick="deleteRemote('${remote.name}')" class="flex-1 px-3 py-2 text-sm font-medium text-red-600 bg-white border border-red-300 rounded hover:bg-red-50 transition-colors">
              ğŸ—‘ï¸ åˆ é™¤
            </button>
          </div>
        </div>
      `).join('');
    }

    // é€šç”¨è¿œç¨‹å®‰è£…åŠŸèƒ½
    async function installFromRemote(url, toolType, profileName, description) {
      // å¦‚æœ toolType ä¸ºç©ºæˆ–ä¸º 'auto'ï¼Œå¼¹å‡ºé€‰æ‹©æ¡†è®©ç”¨æˆ·é€‰æ‹©
      let selectedToolType = toolType;
      if (!toolType || toolType === 'auto' || toolType === '') {
        const content = `
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">é€‰æ‹©å·¥å…·ç±»å‹</h3>
            <p class="text-sm text-gray-500 mb-4">è¯·é€‰æ‹©è¦å®‰è£…çš„å·¥å…·ç±»å‹</p>
            <div class="space-y-2 mb-6">
              <div class="flex items-center">
                <input id="install-claude" name="install-type" type="radio" value="claude" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                <label for="install-claude" class="ml-3 block text-sm text-gray-700">
                  Claude
                </label>
              </div>
              <div class="flex items-center">
                <input id="install-codex" name="install-type" type="radio" value="codex" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                <label for="install-codex" class="ml-3 block text-sm text-gray-700">
                  Codex
                </label>
              </div>
            </div>
            <div class="flex space-x-3">
              <button onclick="handleInstallCancel()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                å–æ¶ˆ
              </button>
              <button onclick="handleInstallConfirm()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ç¡®å®š
              </button>
            </div>
          </div>
        `;

        const typeChoice = await new Promise((resolve) => {
          openModal(content);

          window.handleInstallConfirm = () => {
            const checkedRadio = document.querySelector('input[name="install-type"]:checked');
            closeModal();
            resolve(checkedRadio ? checkedRadio.value : null);
          };

          window.handleInstallCancel = () => {
            closeModal();
            resolve(null);
          };
        });

        if (!typeChoice) return;
        selectedToolType = typeChoice;
      }

      // å¦‚æœæ²¡æœ‰æä¾› profileNameï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥
      let finalProfileName = profileName;
      let finalDescription = description;
      if (!finalProfileName) {
        finalProfileName = await showPrompt('è¯·è¾“å…¥æ–° Profile çš„åç§°', '', 'ä»è¿œç¨‹æºå®‰è£…');
        if (!finalProfileName) return;
        
        // åŒæ—¶è¯¢é—®æè¿°ä¿¡æ¯
        finalDescription = await showPrompt('è¯·è¾“å…¥ Profile çš„æè¿°ï¼ˆå¯é€‰ï¼‰', '', 'æ·»åŠ æè¿°');
        // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œdescription ä¸º nullï¼Œæˆ‘ä»¬å°†å…¶è®¾ä¸ºç©ºå­—ç¬¦ä¸²
        if (finalDescription === null) finalDescription = '';
      }

      // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
      showProgressModal('æ­£åœ¨å®‰è£…è¿œç¨‹æ¨¡æ¿...');

      try {
        const response = await fetch('/api/remotes/install', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            url, 
            profileName: finalProfileName, 
            toolType: selectedToolType, 
            description: finalDescription || '', 
            stream: true 
          })
        });

        if (!response.body) {
          throw new Error('Response body is null');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (data.type === 'progress') {
                  updateProgressModal(data.message);
                } else if (data.type === 'complete') {
                  showSuccessModal(data.message, finalProfileName, selectedToolType);
                  // åˆ·æ–°è¿œç¨‹æºåˆ—è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨è¿œç¨‹æºé¡µé¢ï¼‰
                  if (!document.getElementById('content-remotes').classList.contains('hidden')) {
                    loadRemotes();
                  }
                  return;
                } else if (data.type === 'error') {
                  closeProgressModal();
                  showToast(data.message, 'error');
                  return;
                }
              } catch (e) {
                console.error('Failed to parse SSE data:', e);
              }
            }
          }
        }

        closeProgressModal();
      } catch (error) {
        console.error('å®‰è£…è¿œç¨‹æ¨¡æ¿å¤±è´¥:', error);
        closeProgressModal();
        showToast('å®‰è£…è¿œç¨‹æ¨¡æ¿å¤±è´¥', 'error');
      }
    }

    
    function showProgressModal(message) {
      const modal = document.getElementById('progress-modal');
      let messageEl = document.getElementById('progress-message');
      let logEl = document.getElementById('progress-log');
      
      // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼ˆè¢«ä¹‹å‰çš„æˆåŠŸæ¨¡æ€æ¡†æ›¿æ¢äº†ï¼‰ï¼Œé‡æ–°åˆ›å»ºè¿›åº¦æ¨¡æ€æ¡†ç»“æ„
      if (!messageEl || !logEl) {
        const modalContent = modal.querySelector('.modal-content');
        modalContent.innerHTML = `
          <!-- æ ‡é¢˜ -->
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">å®‰è£…è¿›åº¦</h3>
            <div id="progress-spinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          </div>
          
          <!-- å½“å‰æ“ä½œ -->
          <div class="mb-4">
            <p id="progress-message" class="text-sm font-medium text-gray-700">æ­£åœ¨åˆå§‹åŒ–...</p>
          </div>
          
          <!-- æ—¥å¿—åŒºåŸŸ -->
          <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
            <div id="progress-log" class="space-y-1 font-mono text-xs">
              <!-- åŠ¨æ€æ·»åŠ æ—¥å¿— -->
            </div>
          </div>
          
          <!-- æç¤º -->
          <div class="mt-4 text-xs text-gray-500 text-center">
            è¯·ä¸è¦å…³é—­æ­¤çª—å£ï¼Œå®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...
          </div>
        `;
        
        // é‡æ–°è·å–å…ƒç´ 
        messageEl = document.getElementById('progress-message');
        logEl = document.getElementById('progress-log');
      }
      
      messageEl.textContent = message;
      logEl.innerHTML = '';
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function updateProgressModal(message) {
      const logEl = document.getElementById('progress-log');
      if (!logEl) {
        console.warn('Progress log element not found, skipping update');
        return;
      }
      
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'text-sm text-gray-600';
      logEntry.innerHTML = `<span class="text-gray-400">[${time}]</span> ${message}`;
      logEl.appendChild(logEntry);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function closeProgressModal() {
      const modal = document.getElementById('progress-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function showSuccessModal(message, profileName, toolType) {
      const modal = document.getElementById('progress-modal');
      
      // æ‰¾åˆ°æ¨¡æ€æ¡†çš„å†…å®¹å®¹å™¨
      const modalContent = modal.querySelector('.modal-content');
      
      // æ›¿æ¢æ•´ä¸ªæ¨¡æ€æ¡†å†…å®¹ä¸ºæˆåŠŸçŠ¶æ€
      modalContent.innerHTML = `
        <div class="space-y-4">
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
              <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">å®‰è£…æˆåŠŸï¼</h3>
            <p class="text-sm text-gray-500 mb-6">${message}</p>
          </div>

          <div class="bg-green-50 rounded-lg p-4 mb-4 border border-green-200">
            <div class="text-sm text-gray-600">
              <div class="font-medium text-green-800 mb-2">ğŸ“‹ Profile ä¿¡æ¯</div>
              <div class="space-y-1">
                <div><span class="text-green-700">åç§°:</span> <span class="font-medium text-green-900">${profileName}</span></div>
                <div><span class="text-green-700">å·¥å…·ç±»å‹:</span> <span class="font-medium text-green-900">${toolType}</span></div>
                <div><span class="text-green-700">çŠ¶æ€:</span> <span class="text-green-600 font-medium">âœ… å¯ç”¨</span></div>
              </div>
            </div>
          </div>

          <div class="flex space-x-3">
            <button onclick="closeAndRefreshModal()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
              ç»§ç»­æµè§ˆ
            </button>
            <button onclick="goToProfilesTab()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 transition-colors">
              ğŸš€ å»é…ç½®ç®¡ç†ä½¿ç”¨
            </button>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
            <div class="flex items-start">
              <span class="text-lg mr-2">ğŸ’¡</span>
              <div>
                <div class="font-medium mb-1">ä¸‹ä¸€æ­¥æ“ä½œï¼š</div>
                <div class="text-xs text-blue-700">
                  Profile "<strong>${profileName}</strong>" å·²æˆåŠŸå®‰è£…ï¼ç‚¹å‡»ä¸Šæ–¹ <strong>"ğŸš€ å»é…ç½®ç®¡ç†ä½¿ç”¨"</strong> æŒ‰é’®åˆ‡æ¢åˆ°é…ç½®ç®¡ç†é¡µé¢ï¼Œåœ¨é‚£é‡Œä½ å¯ä»¥ï¼š
                  <ul class="list-disc list-inside mt-1 ml-2 space-y-0.5">
                    <li>æŸ¥çœ‹ Profile è¯¦ç»†ä¿¡æ¯</li>
                    <li>åˆ‡æ¢åˆ°è¯¥ Profile ä½¿ç”¨</li>
                    <li>æŸ¥çœ‹å’Œç¼–è¾‘é…ç½®æ–‡ä»¶</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function goToProfilesTab() {
      closeProgressModal();
      switchTab('profiles');
      // åˆ·æ–°æ•°æ®ä»¥æ˜¾ç¤ºæ–°å®‰è£…çš„ Profile
      refreshData();
    }

    async function closeAndRefreshModal() {
      closeProgressModal();
      // åˆ·æ–° Profiles åˆ—è¡¨ï¼Œç¡®ä¿æ–°å®‰è£…çš„ Profile èƒ½æ˜¾ç¤º
      await refreshData();
      // åˆ·æ–°è¿œç¨‹æºåˆ—è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨è¿œç¨‹æºé¡µé¢ï¼‰
      if (!document.getElementById('content-remotes').classList.contains('hidden')) {
        await loadRemotes();
      }
    }

    async function deleteRemote(name) {
      const confirmed = await showConfirm(
        `ç¡®å®šè¦åˆ é™¤è¿œç¨‹æº "${name}" å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šè¿™å°†åŒæ—¶åˆ é™¤å¯¹åº”çš„ Profile "${name}"`,
        'åˆ é™¤è¿œç¨‹æºå’Œ Profile'
      );
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/api/remotes/${name}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          await loadRemotes();
          await refreshData(); // åˆ·æ–° Profiles åˆ—è¡¨
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤è¿œç¨‹æºå¤±è´¥:', error);
        showToast('åˆ é™¤è¿œç¨‹æºå¤±è´¥', 'error');
      }
    }

    // ============ Backups ç›¸å…³å‡½æ•° ============
    
    async function loadBackups() {
      const loading = document.getElementById('backups-loading');
      const list = document.getElementById('backups-list');
      const empty = document.getElementById('backups-empty');
      
      loading.classList.remove('hidden');
      list.classList.add('hidden');
      empty.classList.add('hidden');
      
      try {
        const toolType = getBackupFilter();
        const response = await fetch(`/api/backups?toolType=${toolType}`);
        const result = await response.json();
        
        if (result.success) {
          backups = result.data;
          renderBackups();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥:', error);
        showToast('è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥', 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    function renderBackups() {
      const list = document.getElementById('backups-list');
      const empty = document.getElementById('backups-empty');
      
      if (backups.length === 0) {
        list.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }
      
      list.classList.remove('hidden');
      empty.classList.add('hidden');
      
      list.innerHTML = '<ul class="divide-y divide-gray-200">' + backups.map(backup => `
        <li class="px-6 py-4 hover:bg-gray-50">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">${new Date(backup.date).toLocaleString('zh-CN')}</p>
              <div class="mt-1 flex items-center space-x-4 text-xs text-gray-500">
                <span>æ—¶é—´æˆ³: ${backup.timestamp}</span>
                ${backup.profileName ? `<span>Profile: ${backup.profileName}</span>` : ''}
                ${backup.toolType ? `<span>ç±»å‹: ${backup.toolType}</span>` : ''}
              </div>
            </div>
            <button onclick="restoreBackup('${backup.timestamp}')" class="ml-4 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">
              æ¢å¤
            </button>
          </div>
        </li>
      `).join('') + '</ul>';
    }

    async function restoreBackup(timestamp) {
      const confirmed = await showConfirm('ç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½å—ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ï¼', 'æ¢å¤å¤‡ä»½');
      if (!confirmed) return;
      
      try {
        const toolType = getBackupFilter();
        const response = await fetch(`/api/backups/${timestamp}/restore?toolType=${toolType}`, {
          method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          await refreshData();
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('æ¢å¤å¤‡ä»½å¤±è´¥:', error);
        showToast('æ¢å¤å¤‡ä»½å¤±è´¥', 'error');
      }
    }

    // ============ åˆå§‹åŒ– ============
    
    async function refreshData() {
      await fetchCurrentProfile();
      await fetchProfiles();
    }

    // ============ Profile æŸ¥çœ‹å™¨ç›¸å…³å‡½æ•° ============
    
    let currentViewingProfile = null;
    let currentFilePath = null;
    let isEditMode = false;
    let originalContent = '';
    let allFiles = []; // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶ç”¨äºæœç´¢
    
    async function viewProfile(name) {
      currentViewingProfile = name;
      const viewer = document.getElementById('profile-viewer');
      const title = document.getElementById('viewer-title');
      const subtitle = document.getElementById('viewer-subtitle');
      
      title.textContent = `Profile: ${name}`;
      subtitle.textContent = 'åŠ è½½æ–‡ä»¶åˆ—è¡¨...';
      viewer.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // åŠ è½½æ–‡ä»¶æ ‘
      await loadFileTree(name);
    }
    
    function closeProfileViewer() {
      const viewer = document.getElementById('profile-viewer');
      viewer.classList.add('hidden');
      document.body.style.overflow = '';
      currentViewingProfile = null;
      currentFilePath = null;
      isEditMode = false;
      allFiles = [];
      
      // æ¸…ç©ºæœç´¢æ¡†
      const fileSearch = document.getElementById('file-search');
      if (fileSearch) fileSearch.value = '';
      
      // é‡ç½®æ–‡ä»¶æ ‘å’Œå†…å®¹åŒºåŸŸ
      document.getElementById('file-tree').innerHTML = '<div class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</div>';
      document.getElementById('file-content').innerHTML = `
        <div class="text-center py-20 text-gray-500">
          <div class="text-4xl mb-4">ğŸ“„</div>
          <div>è¯·ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹</div>
        </div>
      `;
      document.getElementById('current-file-path').textContent = 'è¯·é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹';
      document.getElementById('file-actions').classList.add('hidden');
    }
    
    async function loadFileTree(name) {
      try {
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/${name}/files?toolType=${toolType}`);
        const result = await response.json();
        
        if (result.success) {
          const subtitle = document.getElementById('viewer-subtitle');
          subtitle.textContent = `è·¯å¾„: ${result.data.path}`;
          
          renderFileTree(result.data.files);
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
        showToast('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥', 'error');
      }
    }
    
    function renderFileTree(files, level = 0) {
      const treeContainer = document.getElementById('file-tree');
      
      if (files.length === 0) {
        treeContainer.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— æ–‡ä»¶</div>';
        return;
      }
      
      // ä¿å­˜æ‰€æœ‰æ–‡ä»¶ç”¨äºæœç´¢
      allFiles = flattenFiles(files);
      
      const html = files.map(file => renderFileNode(file, level)).join('');
      treeContainer.innerHTML = html;
    }
    
    // æ‰å¹³åŒ–æ–‡ä»¶æ ‘ä»¥ä¾¿æœç´¢
    function flattenFiles(files, result = []) {
      for (const file of files) {
        result.push(file);
        if (file.type === 'directory' && file.children) {
          flattenFiles(file.children, result);
        }
      }
      return result;
    }
    
    // æ–‡ä»¶æ ‘æœç´¢è¿‡æ»¤
    function filterFileTree() {
      const searchInput = document.getElementById('file-search');
      const searchTerm = searchInput.value.toLowerCase().trim();
      const treeContainer = document.getElementById('file-tree');
      
      if (!searchTerm) {
        // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œé‡æ–°æ¸²æŸ“åŸå§‹æ ‘
        const result = currentViewingProfile ? allFiles : [];
        if (allFiles.length > 0) {
          // é‡æ–°åŠ è½½å®Œæ•´æ ‘
          loadFileTree(currentViewingProfile);
        }
        return;
      }
      
      // è¿‡æ»¤æ–‡ä»¶
      const filtered = allFiles.filter(file => 
        file.name.toLowerCase().includes(searchTerm)
      );
      
      if (filtered.length === 0) {
        treeContainer.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">ğŸ”</div>
            <div class="text-sm">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶</div>
          </div>
        `;
        return;
      }
      
      // æ¸²æŸ“æœç´¢ç»“æœï¼ˆæ‰å¹³åˆ—è¡¨ï¼‰
      const html = filtered.map(file => {
        const icon = file.type === 'directory' ? 'ğŸ“' : getFileIcon(file.name);
        const sizeText = file.type === 'file' ? formatFileSize(file.size) : '';
        return `
          <div class="flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer" onclick="${file.type === 'file' ? `loadFileContent('${file.path.replace(/\\/g, '/')}')` : ''}">
            <span class="mr-2">${icon}</span>
            <span class="text-gray-300 flex-1">${file.name}</span>
            ${sizeText ? `<span class="ml-auto text-xs text-gray-500">${sizeText}</span>` : ''}
          </div>
        `;
      }).join('');
      
      treeContainer.innerHTML = html;
    }
    
    function renderFileNode(node, level) {
      const indent = level * 16;
      
      if (node.type === 'directory') {
        const childrenHtml = node.children ? node.children.map(child => renderFileNode(child, level + 1)).join('') : '';
        return `
          <div class="mb-1">
            <div class="flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer" style="padding-left: ${indent + 8}px" onclick="toggleDirectory(this)">
              <span class="mr-2 folder-icon">ğŸ“</span>
              <span class="text-gray-300">${node.name}</span>
            </div>
            <div class="folder-children">
              ${childrenHtml}
            </div>
          </div>
        `;
      } else {
        const icon = getFileIcon(node.name);
        return `
          <div class="flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer" style="padding-left: ${indent + 8}px" onclick="loadFileContent('${node.path.replace(/\\/g, '/')}')">
            <span class="mr-2">${icon}</span>
            <span class="text-gray-300">${node.name}</span>
            <span class="ml-auto text-xs text-gray-500">${formatFileSize(node.size)}</span>
          </div>
        `;
      }
    }
    
    function toggleDirectory(element) {
      const children = element.nextElementSibling;
      const icon = element.querySelector('.folder-icon');
      
      if (children.style.display === 'none') {
        children.style.display = 'block';
        icon.textContent = 'ğŸ“';
      } else {
        children.style.display = 'none';
        icon.textContent = 'ğŸ“‚';
      }
    }
    
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const iconMap = {
        'md': 'ğŸ“',
        'txt': 'ğŸ“„',
        'json': 'ğŸ“‹',
        'xml': 'ğŸ“‹',
        'yaml': 'ğŸ“‹',
        'yml': 'ğŸ“‹',
        'js': 'ğŸ“œ',
        'ts': 'ğŸ“œ',
        'py': 'ğŸ',
        'sh': 'âš™ï¸',
        'png': 'ğŸ–¼ï¸',
        'jpg': 'ğŸ–¼ï¸',
        'jpeg': 'ğŸ–¼ï¸',
        'gif': 'ğŸ–¼ï¸',
        'svg': 'ğŸ–¼ï¸'
      };
      return iconMap[ext] || 'ğŸ“„';
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    async function loadFileContent(filePath) {
      try {
        // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œå…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼
        if (isEditMode) {
          cancelEdit();
        }
        
        const filePathDisplay = document.getElementById('current-file-path');
        const fileContent = document.getElementById('file-content');
        const fileActions = document.getElementById('file-actions');
        
        filePathDisplay.textContent = `åŠ è½½ä¸­: ${filePath}`;
        fileContent.innerHTML = '<div class="text-center py-20 text-gray-500">åŠ è½½ä¸­...</div>';
        fileActions.classList.add('hidden');
        
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/${currentViewingProfile}/files/content?toolType=${toolType}&path=${encodeURIComponent(filePath)}`);
        const result = await response.json();
        
        if (result.success) {
          currentFilePath = filePath;
          originalContent = result.data.content;
          filePathDisplay.textContent = filePath;
          
          // è½¬ä¹‰ HTML å¹¶æ˜¾ç¤º
          const escapedContent = result.data.content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
          
          fileContent.innerHTML = `<pre class="whitespace-pre-wrap break-words">${escapedContent}</pre>`;
          
          // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
          fileActions.classList.remove('hidden');
        } else {
          filePathDisplay.textContent = filePath + ' (åŠ è½½å¤±è´¥)';
          fileContent.innerHTML = `<div class="text-center py-20 text-red-400">${result.message}</div>`;
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
        showToast('åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥', 'error');
      }
    }
    
    function enterEditMode() {
      isEditMode = true;
      
      const fileContent = document.getElementById('file-content');
      const fileEditor = document.getElementById('file-editor');
      const editBtn = document.getElementById('edit-btn');
      const saveBtn = document.getElementById('save-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      
      // éšè—åªè¯»å†…å®¹ï¼Œæ˜¾ç¤ºç¼–è¾‘å™¨
      fileContent.classList.add('hidden');
      fileEditor.classList.remove('hidden');
      fileEditor.value = originalContent;
      
      // åˆ‡æ¢æŒ‰é’®
      editBtn.classList.add('hidden');
      saveBtn.classList.remove('hidden');
      cancelBtn.classList.remove('hidden');
      
      // èšç„¦ç¼–è¾‘å™¨
      fileEditor.focus();
    }
    
    function cancelEdit() {
      isEditMode = false;
      
      const fileContent = document.getElementById('file-content');
      const fileEditor = document.getElementById('file-editor');
      const editBtn = document.getElementById('edit-btn');
      const saveBtn = document.getElementById('save-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      
      // æ˜¾ç¤ºåªè¯»å†…å®¹ï¼Œéšè—ç¼–è¾‘å™¨
      fileContent.classList.remove('hidden');
      fileEditor.classList.add('hidden');
      
      // åˆ‡æ¢æŒ‰é’®
      editBtn.classList.remove('hidden');
      saveBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');
    }
    
    async function saveFileContent() {
      try {
        const fileEditor = document.getElementById('file-editor');
        const newContent = fileEditor.value;
        
        const toolType = getToolType();
        const response = await fetch(`/api/profiles/${currentViewingProfile}/files/content?toolType=${toolType}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            path: currentFilePath,
            content: newContent
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          originalContent = newContent;
          showToast('æ–‡ä»¶ä¿å­˜æˆåŠŸ', 'success');
          
          // é€€å‡ºç¼–è¾‘æ¨¡å¼å¹¶é‡æ–°åŠ è½½
          cancelEdit();
          await loadFileContent(currentFilePath);
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
        showToast('ä¿å­˜æ–‡ä»¶å¤±è´¥', 'error');
      }
    }

    // ========================================
    // é”®ç›˜å¿«æ·é”®ç³»ç»Ÿ
    // ========================================
    
    document.addEventListener('keydown', (e) => {
      // Ctrl+S / Cmd+S - ä¿å­˜æ–‡ä»¶ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ï¼‰
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        if (isEditMode) {
          e.preventDefault();
          saveFileContent();
        }
      }
      
      // ESC - å…³é—­æ¨¡æ€æ¡†æˆ–æŸ¥çœ‹å™¨
      if (e.key === 'Escape') {
        // ä¼˜å…ˆå…³é—­ Profile æŸ¥çœ‹å™¨
        const viewer = document.getElementById('profile-viewer');
        if (!viewer.classList.contains('hidden')) {
          closeProfileViewer();
          return;
        }
        
        // å…¶æ¬¡å…³é—­åˆ›å»º Profile æ¨¡æ€æ¡†
        const createModal = document.getElementById('create-profile-modal');
        if (createModal && !createModal.classList.contains('hidden')) {
          closeCreateProfileModal();
          return;
        }
        
        // ç„¶åå…³é—­é€šç”¨æ¨¡æ€æ¡†
        const modal = document.getElementById('modal-container');
        if (!modal.classList.contains('hidden')) {
          closeModal();
          return;
        }
        
        // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œé€€å‡ºç¼–è¾‘
        if (isEditMode) {
          cancelEdit();
        }
      }
      
      // Ctrl+F / Cmd+F - èšç„¦æœç´¢æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        const searchInput = document.getElementById('profile-search');
        if (searchInput && !searchInput.classList.contains('hidden')) {
          e.preventDefault();
          searchInput.focus();
        }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–å·¥å…·ç±»å‹æŒ‰é’®çŠ¶æ€
      document.getElementById('filter-claude').classList.add('active');
      document.getElementById('template-claude').classList.add('active');
      document.getElementById('remote-claude').classList.add('active');
      document.getElementById('backup-claude').classList.add('active');

      // é»˜è®¤æ¿€æ´»é…ç½®ç®¡ç† Tabï¼ˆç›´æ¥è®¾ç½®æ ·å¼ç¡®ä¿ç«‹å³ç”Ÿæ•ˆï¼‰
      const profilesTab = document.getElementById('tab-profiles');
      profilesTab.classList.add('tab-active');
      profilesTab.classList.remove('border-transparent', 'text-gray-500');

      // ç¡®ä¿é…ç½®ç®¡ç†å†…å®¹åŒºåŸŸå¯è§
      document.getElementById('content-profiles').classList.remove('hidden');
      
      // ç»‘å®šåˆ›å»º Profile è¡¨å•æäº¤äº‹ä»¶
      document.getElementById('create-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('profile-name').value.trim();
        const description = document.getElementById('profile-description').value.trim();
        const toolType = document.getElementById('profile-tool-type').value;
        const fromCurrent = document.getElementById('from-current').checked;
        
        if (!name) {
          showToast('è¯·è¾“å…¥ Profile åç§°', 'error');
          return;
        }
        
        try {
          const response = await fetch('/api/profiles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, toolType, fromCurrent })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast(result.message, 'success');
            closeCreateProfileModal();
            await refreshData();
          } else {
            showToast(result.message, 'error');
          }
        } catch (error) {
          console.error('åˆ›å»º profile å¤±è´¥:', error);
          showToast('åˆ›å»º profile å¤±è´¥', 'error');
        }
      });
      
      // ç»‘å®šå¿«é€Ÿå®‰è£…è¡¨å•æäº¤äº‹ä»¶
      document.getElementById('quick-install-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const url = document.getElementById('quick-url').value.trim();
        const profileName = document.getElementById('quick-profile-name').value.trim();
        const toolType = document.getElementById('quick-tool-type').value;
        const description = document.getElementById('quick-description').value.trim();

        if (!url || !profileName) {
          showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
          return;
        }

        // ä½¿ç”¨ä¸è¿œç¨‹æºå®‰è£…ç›¸åŒçš„é€»è¾‘ï¼Œä¼ é€’æè¿°ä¿¡æ¯
        await installFromRemote(url, toolType, profileName, description);

        // å®‰è£…å®Œæˆåæ¸…ç©ºè¡¨å•
        document.getElementById('quick-install-form').reset();

        // åˆ·æ–°è¿œç¨‹æºåˆ—è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨è¿œç¨‹æºé¡µé¢ï¼‰
        if (!document.getElementById('content-remotes').classList.contains('hidden')) {
          await loadRemotes();
        }
      });
      
      refreshData();
    });
  </script>

  <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
  <div id="modal-container" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeModal()"></div>
    
    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="modal-content relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div id="modal-body">
          <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ’å…¥ -->
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»º Profile æ¨¡æ€æ¡† -->
  <div id="create-profile-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeCreateProfileModal()"></div>
    
    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="modal-content relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
        <!-- æ ‡é¢˜ -->
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">åˆ›å»ºæ–° Profile</h3>
          <button onclick="closeCreateProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
            âœ•
          </button>
        </div>
        
        <!-- è¡¨å• -->
        <form id="create-form" class="space-y-6">
          <div>
            <label for="profile-name" class="block text-sm font-medium text-gray-700">Profile åç§° *</label>
            <input type="text" id="profile-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <p class="mt-1 text-sm text-gray-500">å»ºè®®ä½¿ç”¨è‹±æ–‡æˆ–æ‹¼éŸ³ï¼Œä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦</p>
          </div>
          
          <div>
            <label for="profile-description" class="block text-sm font-medium text-gray-700">æè¿°</label>
            <textarea id="profile-description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">å·¥å…·ç±»å‹ *</label>
            <input type="hidden" id="profile-tool-type" value="claude" required />
            <div class="mt-2 inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1">
              <button type="button" onclick="setCreateToolType('claude')" id="create-claude" class="tool-type-btn active px-6 py-2 text-sm font-medium rounded-md transition-all">
                Claude
              </button>
              <button type="button" onclick="setCreateToolType('codex')" id="create-codex" class="tool-type-btn px-6 py-2 text-sm font-medium rounded-md transition-all">
                Codex
              </button>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">åˆ›å»ºæ–¹å¼ *</label>
            <div class="mt-2 space-y-2">
              <div class="flex items-center">
                <input id="from-current" name="create-type" type="radio" value="current" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                <label for="from-current" class="ml-3 block text-sm text-gray-700">
                  ä»å½“å‰é…ç½®åˆ›å»º
                  <span class="text-gray-500">(å¤åˆ¶å½“å‰å·¥å…·çš„é…ç½®æ–‡ä»¶)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input id="from-empty" name="create-type" type="radio" value="empty" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                <label for="from-empty" class="ml-3 block text-sm text-gray-700">
                  åˆ›å»ºç©ºç™½ Profile
                  <span class="text-gray-500">(åˆ›å»ºç©ºçš„é…ç½®)</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
            <button type="button" onclick="closeCreateProfileModal()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              å–æ¶ˆ
            </button>
            <button type="button" onclick="resetCreateForm()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              é‡ç½®
            </button>
            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
              åˆ›å»º Profile
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- è¿›åº¦æ˜¾ç¤ºæ¨¡æ€æ¡† -->
  <div id="progress-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    
    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="modal-content relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
        <!-- æ ‡é¢˜ -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-900">å®‰è£…è¿›åº¦</h3>
          <div id="progress-spinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        </div>
        
        <!-- å½“å‰æ“ä½œ -->
        <div class="mb-4">
          <p id="progress-message" class="text-sm font-medium text-gray-700">æ­£åœ¨åˆå§‹åŒ–...</p>
        </div>
        
        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
          <div id="progress-log" class="space-y-1 font-mono text-xs">
            <!-- åŠ¨æ€æ·»åŠ æ—¥å¿— -->
          </div>
        </div>
        
        <!-- æç¤º -->
        <div class="mt-4 text-xs text-gray-500 text-center">
          è¯·ä¸è¦å…³é—­æ­¤çª—å£ï¼Œå®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...
        </div>
      </div>
    </div>
  </div>

  <!-- Profile æŸ¥çœ‹å™¨ -->
  <div id="profile-viewer" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-95">
    <div class="h-full flex flex-col">
      <!-- å¤´éƒ¨ -->
      <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-xl font-semibold text-white" id="viewer-title">Profile æŸ¥çœ‹å™¨</h2>
          <p class="text-sm text-gray-400 mt-1" id="viewer-subtitle"></p>
        </div>
        <button onclick="closeProfileViewer()" class="text-gray-400 hover:text-white text-2xl">
          âœ•
        </button>
      </div>
      
      <!-- ä¸»å†…å®¹åŒº -->
      <div class="flex-1 flex overflow-hidden">
        <!-- å·¦ä¾§æ–‡ä»¶æ ‘ -->
        <div class="w-80 bg-gray-800 border-r border-gray-700 overflow-y-auto flex flex-col">
          <div class="p-4 border-b border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 mb-3">æ–‡ä»¶åˆ—è¡¨</h3>
            <!-- æ–‡ä»¶æœç´¢æ¡† -->
            <div class="relative">
              <input 
                type="text" 
                id="file-search" 
                placeholder="æœç´¢æ–‡ä»¶..." 
                oninput="filterFileTree()"
                class="w-full px-3 py-1.5 pl-8 text-sm bg-gray-700 text-gray-300 border border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
              <svg class="absolute left-2 top-2 h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-4">
            <div id="file-tree" class="text-sm">
              <div class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>
        
        <!-- å³ä¾§æ–‡ä»¶å†…å®¹ -->
        <div class="flex-1 bg-gray-900 overflow-hidden flex flex-col">
          <div class="bg-gray-800 border-b border-gray-700 px-6 py-3 flex justify-between items-center">
            <div class="text-sm text-gray-300" id="current-file-path">è¯·é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹</div>
            <div id="file-actions" class="hidden space-x-2">
              <button id="edit-btn" onclick="enterEditMode()" class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                âœï¸ ç¼–è¾‘
              </button>
              <button id="save-btn" onclick="saveFileContent()" class="hidden px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">
                ğŸ’¾ ä¿å­˜
              </button>
              <button id="cancel-btn" onclick="cancelEdit()" class="hidden px-3 py-1.5 text-sm font-medium text-gray-300 bg-gray-700 rounded hover:bg-gray-600">
                âœ• å–æ¶ˆ
              </button>
            </div>
          </div>
          <div class="flex-1 overflow-auto p-6 relative">
            <div id="file-content" class="text-gray-300 font-mono text-sm">
              <div class="text-center py-20 text-gray-500">
                <div class="text-4xl mb-4">ğŸ“„</div>
                <div>è¯·ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹</div>
              </div>
            </div>
            <textarea id="file-editor" class="hidden absolute inset-0 w-full h-full bg-gray-800 text-gray-300 font-mono text-sm p-4 border-0 focus:outline-none resize-none" style="min-height: 100%;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
